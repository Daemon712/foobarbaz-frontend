<div class="jumbotron" *ngIf="challenge">
  <h1 class="display-3">{{challenge.name}}</h1>
  <p class="lead">{{challenge.abstract}}</p>
</div>
<div class="jumbotron" *ngIf="!challenge">
  <h1 class="display-3">Загрузка...</h1>
</div>
<tabset>
  <tab heading="Описание" class="py-3">
    <div class="row">
      <div class="col-md-8">
        <div [hidden]="challenge" class="lead text-center alert alert-info">
          <i class="fa fa-spinner fa-pulse"></i>
          <span> Загрузка...</span>
        </div>
        <div class="card description" *ngIf="challenge">
          <div class="card-block text-justify" [innerHTML]="challenge.description"></div>
        </div>
      </div>
      <div class="col-md-4" *ngIf="challenge">
        <div class="card">
          <table class="table mb-0">
            <tbody>
            <tr>
              <td>Автор</td>
              <td>
                <i class="fa fa-user"></i>
                <a [routerLink]="'/users/' + challenge.author"> {{challenge.author}}</a>
              </td>
            </tr>
            <tr>
              <td>Дата создания</td>
              <td>
                <span>{{challenge.created | date:'d MMM yyyy'}}</span>
              </td>
            </tr>
            <tr >
              <td>Рейтинг</td>
              <td>
                <rating [ngModel]="challenge.rating * 5"
                        [readonly]="true" [max]="5"
                        stateOn="fa fa-star text-warning">
                </rating>
              </td>
            </tr>
            <tr>
              <td>Сложность</td>
              <td>
                <rating [ngModel]="challenge.difficulty * 5"
                        [readonly]="true" [max]="5"
                        stateOn="fa fa-asterisk text-primary">
                </rating>
              </td>
            </tr>
            <tr>
              <td>Просмотры</td>
              <td>
                <span>{{challenge.views}} </span>
                <i class="fa fa-eye"></i>
              </td>
            </tr>
            <tr>
              <td>Успешные решения</td>
              <td [class.text-success]="challenge.status === challengeStatus.Completed">
                <span>{{challenge.solutions}} </span>
                <i class="fa fa-check"></i>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
        <div class="row my-3">
          <div class="col-6">
            <button type="button"
                    [class.active]="challenge.bookmark"
                    (click)="updateBookmark()"
                    class="btn btn-outline-primary btn-block">
              <i class="fa fa-bookmark"></i>
              <span> В закладки</span>
            </button>
          </div>
          <div class="col-6">
            <button type="button"
                    [class.active]="challenge.userDifficulty || challenge.userRating"
                    (click)="ratingModal.show()"
                    class="btn btn-outline-warning btn-block">
              <i class="fa fa-star"></i>
              <span> Оценить</span>
            </button>
          </div>
        </div>
        <div>
          <span *ngFor="let tag of challenge.tags"
                class="badge badge-default mr-1">{{tag}}</span>
          <i class="fa fa-tags m-1 text-muted"></i>
        </div>
      </div>
    </div>
  </tab>
  <tab heading="Решение" class="py-3" (select)="openSolutionTab()">
    <div class="row">
      <div class="col-md-8">
        <div [hidden]="challenge" class="lead text-center alert alert-info">
          <i class="fa fa-spinner fa-pulse"></i>
          <span> Загрузка...</span>
        </div>
        <ace-editor class="form-control"
                    *ngIf="revision"
                    [(text)]="revision.newSolution"
                    [readOnly]="submitted"
                    [mode]="'java'" [theme]="'dreamweaver'" [options]="options">
        </ace-editor>
      </div>
      <div class="col-md-4">
        <button type="button" class="btn btn-primary btn-block btn-lg mb-2"
                [disabled]="!(revision && (revision.solution !== revision.newSolution || revision.status === solutionStatus.empty))"
                title="Сохранить и протестировать решение"
                (click)="testSolution()">
          <i class="fa fa-play"></i>
          <span> Протестировать</span>
        </button>
        <div class="mb-3 d-flex justify-content-between">
          <button type="button" class="btn btn-success"
                  (click)="addSolution()"
                  title="Добавить новое решение">
            <i class="fa fa-plus"></i>
          </button>
          <button type="button" class="btn btn-secondary"
                  (click)="copySolution()"
                  title="Скопировать в новое решение">
            <i class="fa fa-paste"></i>
          </button>
          <button type="button" class="btn btn-secondary"
                  [disabled]="!(revision && revision.solution !== revision.newSolution)"
                  title="Сохранить решение без тестирования"
                  (click)="saveSolution()">
            <i class="fa fa-save"></i>
          </button>
          <button type="button" class="btn btn-info"
                  [disabled]="!(revision && revision.solution === revision.newSolution && revision.status !== solutionStatus.created)"
                  title="Поделиться решением"
                  (click)="shareSolution()">
            <i class="fa fa-share-alt"></i>
          </button>
          <button type="button" class="btn btn-warning"
                  [disabled]="!(revision && revision.solution !== revision.newSolution)"
                  title="Сбросить изменения"
                  (click)="revertChanges()">
            <i class="fa fa-undo"></i>
          </button>
          <button type="button" class="btn btn-danger"
                  (click)="removeSolution()"
                  title="Удалить решение">
            <i class="fa fa-close"></i>
          </button>
        </div>
        <div>
          <app-revision-list
            [revisions]="revisions"
            [activeRevisionId]="revision?.id"
            (revisionSelected)="openRevision($event)">
          </app-revision-list>
        </div>
      </div>
    </div>
    </tab>
  <tab heading="Результаты тестов" class="py-3" *ngIf="revision?.testResults"
       (deselect)="testResultsActive = false" [active]="testResultsActive">
    <div class="card">
      <app-test-results-table [testResults]="revision?.testResults">
      </app-test-results-table>
    </div>
  </tab>
</tabset>

<div class="row">
  <div class="col-md-8">
    <tabset type="pills" [justified]="true" *ngIf="challenge">
      <tab customClass="tab-sm tab-success pr-2" class="py-3">
        <template tabHeading>
          <i class="fa fa-plus"></i>
          <span> Комментировать</span>
        </template>
        <textarea title="comment" [(ngModel)]="newComment" class="form-control mb-2"></textarea>
        <button type="button" class="btn btn-primary btn-sm"
                [disabled]="!newComment" (click)="sendComment()">
          Оставить комментарий
        </button>
        <button type="button" class="btn btn-secondary btn-sm"
                [disabled]="!newComment" (click)="newComment = ''">
          Отмена
        </button>
      </tab>
      <tab customClass="tab-sm tab-info px-2" class="py-3"
           [disabled]="!challenge.comments && !comments?.length" (select)="loadComments()">
        <template tabHeading>
          <span>Комментарии </span>
          <i class="fa fa-comments"></i>
          <span> {{comments?.length || challenge.comments || 0}}</span>
        </template>
        <app-comments [comments]="comments" (commentLiked)="commentLiked($event)"></app-comments>
      </tab>
      <tab customClass="tab-sm tab-info pl-2" class="py-3"
           [disabled]="!challenge.sharedSolutions && !sharedSolutions?.length" (select)="loadSolutions()">
        <template tabHeading>
          <span>Опубл. решения </span>
          <i class="fa fa-share-alt"></i>
          <span> {{sharedSolutions?.length || challenge.sharedSolutions || 0}}</span>
        </template>
        <app-shared-solution-list [solutions]="sharedSolutions"></app-shared-solution-list>
      </tab>
    </tabset>
  </div>
</div>

<div bsModal #ratingModal="bs-modal"
     class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title pull-left">Ваша оценка</h4>
        <button type="button" class="close pull-right" aria-label="Close"
                (click)="closeUserRating()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group row">
          <label class="col-6">Рейтинг</label>
          <div class="col-6">
            <rating [(ngModel)]="userRating.rating" [max]="5"
                    stateOn="fa fa-lg fa-star text-warning"
                    stateOff="fa fa-lg fa-star text-muted">
            </rating>
          </div>
        </div>
        <div class="form-group row">
          <label class="col-6">Сложность</label>
          <div class="col-6">
            <rating [(ngModel)]="userRating.difficulty" [max]="5"
                    stateOn="fa fa-lg fa-asterisk text-primary"
                    stateOff="fa fa-lg fa-asterisk text-muted">
            </rating>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button [disabled]="!userRating.rating || !userRating.difficulty"
                class="btn btn-primary btn-sm"
                (click)="updateUserRating()">
          Сохранить оценку
        </button>
        <button class="btn btn-secondary btn-sm" (click)="closeUserRating()">
          Отмена
        </button>
      </div>
    </div>
  </div>
</div>
